<html>

<head>
<meta http-equiv="Content-Language" content="en-us">
<meta name="GENERATOR" content="Microsoft FrontPage 6.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>Konnect PWM to Analog Example</title>
  
</head>

<body>

<p><i><b><font size="5" face="Arial">KONNECT - </font></b></i><b><i>
<font face="Arial" size="5">PWM to Analog Example</font></i></b></p>
<p><font face="Arial">KFLOP+Konnect+Simple Filter Circuit can be used to produce 
a programmable analog signal.&nbsp; This might be used as a basic Spindle Speed 
Control Signal if no others are available.</font></p>
<p><font face="Arial">This demonstrates the flexibility of the Konnect Outputs 
which are Isolated, can sink or source current, fast, medium power, and low 
impedance</font></p>
<p><u><i><b><font face="Arial" size="4">Results</font></b></i></u></p>
<p><font face="Arial">Analog Oscilloscope traces of Analog signals generated by 
a KFLOP Software generated PWM Signal controlling two optically isolated Konnect 
Outputs that are then passed through a simple low pass filter. </font></p>
<p><font face="Arial">High resolution and response rates easily usable for speed 
control applications</font></p>
<p><img border="0" src="SineWave.png" width="800" height="480"></p>
<p>&nbsp;</p>
<p><font face="Arial">Square wave to test large signal changes.&nbsp; 
Significant change in &lt; 25ms</font></p>
<p><img border="0" src="SquareWave.png" width="806" height="486"></p>
<p>&nbsp;</p>
<p><font face="Arial">Reasonable linearity.&nbsp; This would require calibration 
if higher accuracy is needed.</font></p>
<p><img border="0" src="LinearityChart.png" width="695" height="572"></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><u><b><i><font face="Arial" size="4">Circuit</font></i></b></u></p>
<p><font face="Arial">Simple cascaded dual low pass filters.&nbsp; Only 5 
components.&nbsp; One resistor type and one capacitor type.&nbsp; Component 
values are not critical (R1 and R2 should be matched).</font></p>
<p><font face="Arial">One Konnect Output charges the capacitors and one output 
discharges them.&nbsp; Both should not be turned on simultaneously (but no 
damage will occur if they are as R1+R2 will limit the current).</font></p>
<p><font face="Arial">The relatively low resistance values (100 Ohms) provides 
low output impedance so that any connected load should have a minimal effect.&nbsp; 
A load of 10Kohms or higher should work well.</font></p>
<p><font face="Arial">Double filtering provides low output ripple, while still 
having relatively quick response to changes, uses reasonably small capacitors, 
even with relatively low PWM rates.&nbsp; </font> </p>
<p><font face="Arial">Konnect Outputs can be updated every 180us.&nbsp; So 180us 
is the basic PWM quantum.&nbsp; This results in ~ 10mV p-p ripple..</font></p>
<p><font face="Arial">&nbsp;</font><img border="0" src="LowPassCircuit.png"></p>
<p><img border="0" src="WiredCircuit.png" width="600" height="450"></p>
<p>&nbsp;</p>
<p><img border="0" src="CircuitTop.png" width="400" height="325"></p>
<p>&nbsp;</p>
<p><u><b><font face="Arial" size="4">Software</font></b></u></p>
<p><font face="Arial">This software example simulates how an RC circuit would 
respond to an applied, switched, high/low voltage.</font></p>
<p><font face="Arial">If the simulated voltage is below the desired output 
voltage then the output is switched high to charge up the capacitor, otherwise 
it is switched low to discharge the capacitor.</font></p>
<p><font face="Arial">The same state that is simulated is also sent to the 
Konnect Outputs to drive the real circuit.&nbsp; The real circuit is a bit more 
complex but the simple model works reasonably well.&nbsp; The two RC circuits 
will eventually evolve to the same voltage as the average PWM Voltage in the 
steady state.&nbsp; Only the transient response will be slightly different.&nbsp; 
Similarly, somewhat incorrect component values will only affect the transient 
response.&nbsp; The progra values were adjusted to get the best response.</font></p>
<p><font face="Arial">The #define statements may require changes for your 
specific circuit and I/O Bit used.</font></p>
<p><font face="Arial">The Vout value is coded to create a sine wave, but more 
typically the value would be passed in through a global persist variable as a 
Spindle Speed Setting. </font></p>
<p>&nbsp;</p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: blue">#include</span><span style="font-size: 8.0pt; font-family: Consolas">
<span style="color:#A31515">&quot;KMotionDef.h&quot;</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: #A31515">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">// Enables a 
Konnect on KFLOP JP4 Aux Port then</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">// PWM's two 
outputs as push-pull drivers such that</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">// when low 
passed filtered with an RC circuit becomes</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">// a 
variable analog source.</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">//</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">// Configure 
KFLOP to service Konnect 32 Input 16 output IO board</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">// Board 
address is 0, </span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">// 16 
Outputs are mapped to Virtual IO 48-63 (VirtualBits)</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">// 32 Inputs 
are mapped to Virtual IO 1024-1055 (VirtualBits[0])</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">//</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">// Attach 
Service to Aux0 Port (KFLOP JP4) instead of standard Aux1 Port (KFLOP JP6)</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">//</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: blue">void</span><span style="font-size: 8.0pt; font-family: Consolas"> 
ServiceKonnectPWM(<span style="color:blue">void</span>);</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: blue">double</span><span style="font-size: 8.0pt; font-family: Consolas"> 
T,T0=0;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: blue">float</span><span style="font-size: 8.0pt; font-family: Consolas"> 
Vout=0.0;&nbsp; <span style="color:green">// desired voltage</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">main()</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">{</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp; InitAux();</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp; AddKonnect_Aux0(0,&amp;VirtualBits,VirtualBitsEx);</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;
<span style="color:blue">for</span>(;;)</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp; {</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; T=WaitNextTimeSlice();</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ServiceKonnectPWM();</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:green">// Fixed</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:green">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Vout = 0.1;</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:green">//Generate a 5 Hz 3V Sine Wave</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Vout = 3.0f*sin(T 
* TWO_PI * 5.0) + 5.0;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:green">//Generate a Saw Tooth wave</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:green">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Vout = 2 + 6.0* (5.0*T - ((int)(5.0*T)));</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:green">//Generate a 5 Hz Square wave</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:green">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Vout = (5.0*T - ((int)(5.0*T))) &gt; 0.5 
? 8 : 2; </span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp; }</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">}</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: blue">#define</span><span style="font-size: 8.0pt; font-family: Consolas"> 
C 0.00029f <span style="color:green">// 1000uF</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: blue">#define</span><span style="font-size: 8.0pt; font-family: Consolas"> 
R 100.0f <span style="color:green">// 100 ohms</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: blue">#define</span><span style="font-size: 8.0pt; font-family: Consolas"> 
Vcc 11.230f <span style="color:green">// supply voltage</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: blue">#define</span><span style="font-size: 8.0pt; font-family: Consolas"> 
HIGH_BIT 62 <span style="color:green">// This output drives Cap high</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: blue">#define</span><span style="font-size: 8.0pt; font-family: Consolas"> 
LOW_BIT&nbsp; 63 <span style="color:green">// This output drives Cap low</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: blue">void</span><span style="font-size: 8.0pt; font-family: Consolas"> 
ServiceKonnectPWM(<span style="color:blue">void</span>)</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">{</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;
<span style="color:blue">static</span> <span style="color:blue">int</span> 
FirstTime=TRUE;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp; &nbsp;&nbsp;<span style="color:blue">static</span>
<span style="color:blue">float</span> Vc=0.0f;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;
<span style="color:blue">static</span> <span style="color:blue">double</span> 
T0;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;
<span style="color:blue">static</span> <span style="color:blue">int</span> 
State;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;
<span style="color:blue">double</span> T=Time_sec(); </span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;
<span style="color:blue">if</span> (FirstTime)</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp; {</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FirstTime=FALSE;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; T0=T;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; State=0;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp; }</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;
<span style="color:blue">else</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp; {</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:blue">float</span> V,I;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:green">// Compute Voltage applied to Cap</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; V=Vcc*State;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:green">// Compute current</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; I=(V-Vc)/R;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:green">// Compute new Cap Voltage</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Vc += I/C*(T-T0);</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:green">// determine next state</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas; color: green">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:blue">if</span> (Vc &gt; Vout)</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>
</p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
ClearBit(HIGH_BIT);</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetBit(LOW_BIT);</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; State=0;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<span style="color:blue">else</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
ClearBit(LOW_BIT);</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
SetBit(HIGH_BIT);</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; State=1;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;</span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; T0=T;
<span style="color:green">// save time when applied</span></span></p>
<p class="MsoNormal" style="line-height: normal; text-autospace: none; margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; font-family: Consolas">&nbsp;&nbsp;&nbsp; }</span></p>
<p class="MsoNormal" style="margin-top: 0; margin-bottom: 0">
<span style="font-size: 8.0pt; line-height: 115%; font-family: Consolas">}</span></p>

</body>

</html>